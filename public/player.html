<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Player | Trivia</title>
  <link rel="stylesheet" href="/styles.css">
  <script src="/socket.io/socket.io.js">
socket.on('timer:tick', (remaining) => {
  timerEl.textContent = remaining;
  if (remaining <= 3 && remaining > 0) { sndBeep.currentTime = 0; sndBeep.play().catch(()=>{}); }
});

socket.on('timer:ended', () => {
  sndReveal.play().catch(()=>{});
});

</script>
</head>
<body>
  <div class="container">
    <h1>üì± Player</h1>
    <audio id="sndBeep" src="/sfx/beep.wav" preload="auto"></audio>
    <audio id="sndBuzz" src="/sfx/buzz.wav" preload="auto"></audio>
    <audio id="sndReveal" src="/sfx/reveal.wav" preload="auto"></audio>
    <div class="card" id="joinCard">
      <label>Your name</label>
      <input id="nameInput" type="text" maxlength="20" placeholder="e.g. Kachi">
      <button class="btn" id="joinBtn">Join Game</button>
      <p class="muted">Up to 6 players can join.</p>
    </div>

    <div class="card" id="gameCard" style="display:none">
      <div class="row">
        <div><span class="badge" id="meName">You</span></div>
        <div><span class="badge">Score: <span id="meScore">0</span></span></div>
      </div>

      <div class="card">
        <h2 id="qText">Waiting for host‚Ä¶</h2>
        <p>‚è±Ô∏è Time left: <strong id="timer">‚Äî</strong>s</p>
        <div id="options" class="grid grid-2"></div>
      </div>

      <div class="row">
        <button class="btn" id="buzzBtn">üîî Buzz</button>
        <span class="muted" id="buzzStatus"></span>
      </div>
    </div>
  </div>

<script>
const socket = io({ query: { role: 'player' } });
let me = { id: null, name: null, score: 0 };
let currentPhase = 'lobby';
let currentQ = null;
let selectedAnswer = null;

const joinCard = document.getElementById('joinCard');
const gameCard = document.getElementById('gameCard');
const nameInput = document.getElementById('nameInput');
const joinBtn = document.getElementById('joinBtn');
const qText = document.getElementById('qText');
const optionsDiv = document.getElementById('options');
const buzzBtn = document.getElementById('buzzBtn');
const buzzStatus = document.getElementById('buzzStatus');
const meName = document.getElementById('meName');
const meScore = document.getElementById('meScore');
const timerEl = document.getElementById('timer');
const sndBeep = document.getElementById('sndBeep');
const sndBuzz = document.getElementById('sndBuzz');
const sndReveal = document.getElementById('sndReveal');

joinBtn.onclick = () => {
  const name = nameInput.value.trim() || 'Player';
  socket.emit('player:join', name, (res) => {
    if (!res.ok) { alert(res.error); return; }
    me = res.player;
    meName.textContent = res.player.name;
    joinCard.style.display = 'none';
    gameCard.style.display = 'block';
    refreshQuestion();
  });
};

buzzBtn.onclick = () => {
  socket.emit('player:buzz');
};

optionsDiv.addEventListener('click', (e) => {
  const card = e.target.closest('.option');
  if (!card) return;
  if (currentPhase !== 'question') return;
  const val = card.dataset.val;
  selectedAnswer = val;
  selectOption(val);
  socket.emit('player:answer', val);
});

function selectOption(val) {
  document.querySelectorAll('.option').forEach(o => {
    o.classList.toggle('selected', o.dataset.val === val);
  });
}

async function refreshQuestion() {
  const res = await fetch('/api/question');
  currentQ = await res.json();
  renderQuestion();
}

function renderQuestion() {
  if (!currentQ) { qText.textContent = 'Waiting for host‚Ä¶'; optionsDiv.innerHTML=''; return; }
  qText.textContent = currentQ.text;
  optionsDiv.innerHTML = '';
  for (const key of ['A','B','C','D']) {
    const div = document.createElement('div');
    div.className = 'option';
    div.dataset.val = key;
    div.innerHTML = `<strong>${key}.</strong> ${currentQ.options[key]}`;
    optionsDiv.appendChild(div);
  }
}

socket.on('buzz:locked', ({ playerId, name }) => { sndBuzz.play().catch(()=>{});
  if (playerId === me.id) {
    buzzStatus.textContent = 'You buzzed first!';
  } else {
    buzzStatus.textContent = `${name} buzzed first.`;
  }
  buzzBtn.disabled = true;
});

socket.on('buzz:reset', () => {
  buzzStatus.textContent = '';
  buzzBtn.disabled = false;
});

socket.on('state:update', (state) => {
  currentPhase = state.phase;
  const mine = state.players.find(p => p.id === me.id);
  if (mine) {
    me.score = mine.score;
    meScore.textContent = me.score;
  }
  if (state.phase === 'question') {
    buzzBtn.disabled = !!state.buzzedBy && state.buzzedBy !== me.id;
    refreshQuestion();
  }
  if (state.phase === 'reveal') {
    // Show correct/wrong styling
    applyRevealStyling();
  }
});

function applyRevealStyling() {
  fetch('/api/question').then(r => r.json()).then(q => {
    if (!q) return;
    const correct = q.correct; // this endpoint hides correct; keep styling minimal
  });
}

socket.on('timer:tick', (remaining) => {
  timerEl.textContent = remaining;
  if (remaining <= 3 && remaining > 0) { sndBeep.currentTime = 0; sndBeep.play().catch(()=>{}); }
});

socket.on('timer:ended', () => {
  sndReveal.play().catch(()=>{});
});

</script>
</body>
</html>
